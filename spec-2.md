
# 規格（Spec v2）：職務類別索引與職缺索引

本文件定義：
- 職務類別（大／中／小）的資料規則
- 用「時間複雜度 O(1)」的型別建立索引
- 「職缺代碼 → 職務類別」與「職務大類 → 職缺」索引需求

> 目標：讓開發者能依此實作、讓測試能依此驗收。

---

## 1. 名詞定義

- **職務類別（JobCategory）**：職務的分類體系，包含大類、中類、小類三個層級。
- **職務大類（Major）**：最上層分類。
- **職務中類（Middle）**：隸屬於某一個大類。
- **職務小類（Minor）**：隸屬於某一個中類。
- **職缺（JobVacancy）**：具體的工作機會，包含職缺編號、標題、說明等資訊。
- **編號（Code）**：分類或職缺的識別碼。類別編號與職缺編號是不同概念。
- **父編號（ParentCode）**：用於表示上層類別的編號。

---

## 2. 職務類別規則（大類／中類／小類）

### 2.0 職務類別欄位定義

每一筆職務類別（大／中／小）至少要包含：

- **編號**：整數（常整數）
- **名稱**：字串
- **父編號**：整數（常整數）
	- 職務大類（Major）該欄位為 null

> 備註：本規格其餘段落所稱的「編號（Code）」與「父編號（ParentCode）」即為上述欄位。

### 2.1 層級約束

- 大類沒有父編號。
- 中類一定要有父編號，且父編號必須對應到一個存在的「大類編號」。
- 小類一定要有父編號，且父編號必須對應到一個存在的「中類編號」。

### 2.2 範例資料（本次規格固定的樣例）

#### 大類
- 名稱：管理幕僚／人資／行政；編號：`100000`

#### 中類
- 名稱：管理幕僚；編號：`100100`；父編號：`100000`
- 名稱：人力資源；編號：`100200`；父編號：`100000`

#### 小類
- 名稱：經營管理主管；編號：`100101`；父編號：`100100`
- 名稱：特別助理；編號：`100105`；父編號：`100100`
- 名稱：人事助理；編號：`100205`；父編號：`100200`
- 名稱：就業服務員；編號：`100206`；父編號：`100200`

---

## 3. 職缺欄位（資料模型需求）

> C# 實作類別：`JobVacancy`

每一筆職缺至少要包含：

- **職缺編號（JobId）**：整數（常整數）
- **工作標題（Title）**：字串（必填）
- **工作說明（Description）**：字串
- **職務小類（MinorCodes）**：可多筆（0..N）
	- 每一筆小類以「小類編號」表示
	- 同一職缺不可重複同一個小類編號（需去重）

---

## 4. 物件設計需求：職務類別層級索引（JobCategoryHierarchyIndex）

> C# 實作類別：`JobCategoryHierarchyIndex`

### 4.0 職務類別工作流程（索引建置）

職務類別索引的建置流程如下：

1. **讀取所有職務類別**
	- 一次性讀取「大／中／小」所有類別資料（同一批資料）。
	- 建置過程不得逐筆掃描全表來推導關聯。

2. **把職務類別分別寫入到索引物件**
	- 將第 1 步讀取到的資料寫入「職務類別層級索引」物件，建立必要的 `Dictionary` / `HashSet` 結構，以支援第 4.2 節所有查詢。
	- 建議寫入順序：
		- 先寫入 **大類（Major）**
		- 再寫入 **中類（Middle）**（需能對應到存在的大類）
		- 最後寫入 **小類（Minor）**（需能對應到存在的中類）
	- 建置時必須檢查並符合第 2.1 節「層級約束」；若類別資料違反層級規則或出現重複類別編號，索引建置應視為失敗（例如丟出例外）。

### 4.2 必備查詢（可驗收）

系統必須提供以下查詢能力（輸入可以是一個編號或多個編號）：

1) **用一個或多個「職務小類」找到多個「職務大類」**
- Input: `minorCodes`（小類編號集合）
- Output: `majorCodes`（大類編號集合）

2) **用一個或多個「職務小類」找到多個「職務中類」**
- Input: `minorCodes`（小類編號集合）
- Output: `middleCodes`（中類編號集合）

3) **用一個或多個「職務中類」找到多個「職務小類」**
- Input: `middleCodes`（中類編號集合）
- Output: `minorCodes`（小類編號集合）

4) **用一個或多個「職務中類」找到多個「職務大類」**
- Input: `middleCodes`（中類編號集合）
- Output: `majorCodes`（大類編號集合）

5) **用一個或多個「職務大類」找到多個「職務小類」**
- Input: `majorCodes`（大類編號集合）
- Output: `minorCodes`（小類編號集合）

6) **用一個或多個「職務大類」找到多個「職務中類」**
- Input: `majorCodes`（大類編號集合）
- Output: `middleCodes`（中類編號集合）

### 4.3 回傳集合規則

- 若輸入包含重複編號，視為同一編號，結果不應重複。
- 若輸入包含不存在的編號：
	- 該編號對結果無貢獻（忽略），不應導致整體查詢失敗。
- 輸出以集合語意呈現（例如 `HashSet`）：不保證順序。

---

## 5. 物件設計需求：職缺索引（JobVacancyIndex）

> C# 實作類別：`JobVacancyIndex`
>
> 通用規則（集合語意、忽略不存在編號等）：同第 4.3 節。

### 5.1 設計原則

- 在建構時預先建置小類/中類/大類索引，避免查詢時跨索引重算（對應第 5.3 節）。
- 若輸入的職缺包含重複的 jobId，會將其 MinorCodes 進行聯集合併。
- 同時建立反向索引：職務大類 → 職缺集合（對應第 6 章）。

### 5.2 必備查詢（可驗收）

系統必須提供以下查詢能力：

1) **用一個或多個「職缺編號」找到多筆「職務小類」**
- Input: `jobIds`（職缺編號集合）
- Output: `minorCodes`（小類編號集合）

2) **用一個或多個「職缺編號」找到多筆「職務中類」**
- Input: `jobIds`（職缺編號集合）
- Output: `middleCodes`（中類編號集合）

3) **用一個或多個「職缺編號」找到多個「職務大類」**
- Input: `jobIds`（職缺編號集合）
- Output: `majorCodes`（大類編號集合）

4) **用一個或多個「職務大類」找到多筆「職缺編號」**（反向查詢，對應第 6.2 節）
- Input: `majorCodes`（大類編號集合）
- Output: `jobIds`（職缺編號集合）

### 5.3 映射規則（由層級索引推導並預先快取）

- 職缺資料只直接儲存「職務小類編號（可多筆）」。
- 中類/大類編號在建構時透過第 4 節的 `JobCategoryHierarchyIndex`，由小類推導並快取。
- **關鍵設計原則**：避免查詢時跨索引重算，所有映射關係在建構時一次性建立。

---

## 6. 建置流程需求：職務大類 → 職缺集合 索引

> 目的：支援以「職務大類」快速找到其所屬的「職缺集合」。
> 
> 實作方式：整合在 `JobVacancyIndex` 中（第 5 章）。

### 6.1 索引建置流程

1. **讀取職缺**
	- 一次性讀取所有職缺資料（同一批資料）。
	- 每筆職缺包含：職缺編號（jobId）與 0..N 個職務小類編號（minorCodes，需去重）。

2. **由職缺小類推導出職務大類**
	- 透過第 4 節索引：小類編號（minorCode）→ 大類編號（majorCode）。
	- 不存在的小類編號（minorCode）忽略。

3. **建立「職務大類 → 職缺集合」索引**
	- 將推導出的大類編號（majorCode）寫入索引，並把該職缺的 jobId 加入對應集合。
	- 建議資料結構：`Dictionary<int, HashSet<int>>`（大類編號 majorCode → 職缺編號集合 jobIds）。
	- 同一個大類編號（majorCode）底下不應重複同一個職缺編號（jobId）（集合語意）。

### 6.2 必備查詢（可驗收）

1) **用一個或多個「職務大類」找到多筆「職缺編號」**
- Input: `majorCodes`（大類編號集合）
- Output: `jobIds`（職缺編號集合）

> 回傳集合規則：同第 4.3 節。
> 
> 實作位置：此查詢已整合在 `JobVacancyIndex.GetJobIdsByMajorCodes()` 方法中（第 5.2 節）。

---

# 非目標（本規格不涵蓋）

- 不定義 UI / API 路由。
- 不定義資料儲存層（例如 MSSQL schema）。
- 不定義排序規則（回傳集合不保證順序）。